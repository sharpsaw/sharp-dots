#!/usr/bin/env ruby
## Preprocess a file using ERb (possibly loading a .yml), then use diffycp to safely copy it into place.
# License info:
# Cloned from https://github.com/mattly/nginx_config_generator/blob/9057034a496fb12bce495c91e7cd6b0d9439cd4b/LICENSE
# Many changes since.

require 'erb'
require 'yaml'

name = ARGV[0]
fail "Needs a config name." unless name
fail "Use the config name without .erb or .yml (was: #{name})" if name.match /\.(erb|ya?ml)/
if File.exists? name+'.yml'
  input_yaml = File.read name+'.yml'
  even_the_yaml_is_erb = ERB.new(input_yaml).result
  config = YAML.load even_the_yaml_is_erb
end
input_erb = File.read name+'.erb'
processed = ERB.new(input_erb, nil, '%<>').result binding
open(name+'.tmp', 'w+').write processed
system 'diffycp', name+'.tmp', name
